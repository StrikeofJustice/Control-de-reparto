<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Delivery - Stats Edition</title>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --neon-green: #39ff14;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: radial-gradient(circle at top, #1b2735 0%, #090a0f 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1 { text-align: center; font-size: 1.2rem; letter-spacing: 3px; background: linear-gradient(to right, var(--neon-blue), var(--neon-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- PANEL DE M√âTRICAS --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 5px;
        }

        .stat-card {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .stat-val { display: block; font-size: 1rem; color: var(--neon-blue); font-weight: bold; }
        .stat-label { font-size: 0.5rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .shift-panel { background: rgba(0, 0, 0, 0.4); padding: 15px; border-radius: 18px; border: 1px solid var(--glass-border); }
        .time-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .input-box { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 0.55rem; color: var(--neon-blue); text-align: center; }
        
        input[type="time"] {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            color: var(--neon-blue);
            padding: 6px;
            border-radius: 6px;
            font-family: 'Orbitron';
            text-align: center;
            font-size: 0.8rem;
        }

        .progress-container { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple)); transition: width 0.5s; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.7rem; font-weight: bold; transition: 0.3s; text-transform: uppercase; }
        .btn-salida { border: 1px solid var(--neon-blue); color: var(--neon-blue); background: transparent; }
        .btn-llegada { border: 1px solid var(--neon-purple); color: var(--neon-purple); background: transparent; }
        .btn:disabled { opacity: 0.1; }

        /* --- HISTORIAL --- */
        .history { max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .pedido-item { background: rgba(255,255,255,0.02); margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--glass-border); }
        .pedido-header { padding: 10px; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.7rem; }
        .pedido-content { display: none; padding: 10px; font-size: 0.6rem; border-top: 1px solid var(--glass-border); color: #ccc; }
        .pedido-content.active { display: block; }

        .loading-text { font-size: 0.6rem; color: var(--neon-blue); text-align: center; display: none; padding: 10px; }
        .btn-reset { background: none; border: none; color: #444; font-size: 0.55rem; cursor: pointer; width: 100%; margin-top: 5px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="container">
    <h1>‚ö° QUANTUM DASHBOARD</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-val" id="totalPedidos">0</span>
            <span class="stat-label">Pedidos</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="totalDist">0.0</span>
            <span class="stat-label">Km Totales</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="totalTime">0h 0m</span>
            <span class="stat-label">En Movimiento</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="avgSpeed">0.0</span>
            <span class="stat-label">Km/h Media</span>
        </div>
    </div>

    <div class="shift-panel">
        <div class="time-inputs">
            <div class="input-box"><label>INICIO</label><input type="time" id="shiftStart" onchange="updateShift()"></div>
            <div class="input-box"><label>FINAL</label><input type="time" id="shiftEnd" onchange="updateShift()"></div>
        </div>
        <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.6rem; color: var(--neon-blue);">
            <span id="percentText">0%</span>
            <span id="tphDisplay">TPH: 0.00</span>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-salida" id="btnSalida" onclick="handleSalida()">SALIDA</button>
        <button class="btn btn-llegada" id="btnLlegada" onclick="handleLlegada()" disabled>LLEGADA</button>
    </div>

    <div id="loading" class="loading-text">ACCEDIENDO A SAT√âLITES GPS...</div>

    <div class="history">
        <p style="font-size: 0.5rem; color: #555; margin-bottom: 5px; letter-spacing: 2px;">REGISTRO DE MISIONES</p>
        <div id="historyList"></div>
    </div>

    <button class="btn-reset" onclick="resetApp()">[ PURGAR SISTEMA ]</button>
</div>

<script>
    let state = {
        pedidos: JSON.parse(localStorage.getItem('dl_v7_pedidos')) || [],
        inProgress: JSON.parse(localStorage.getItem('dl_v7_progress')) || null,
        shiftStart: localStorage.getItem('dl_v7_start') || "09:00",
        shiftEnd: localStorage.getItem('dl_v7_end') || "17:00"
    };

    function init() {
        document.getElementById('shiftStart').value = state.shiftStart;
        document.getElementById('shiftEnd').value = state.shiftEnd;
        if(state.inProgress) {
            document.getElementById('btnSalida').disabled = true;
            document.getElementById('btnLlegada').disabled = false;
        }
        renderAll();
        updateShift();
        setInterval(updateShift, 30000);
    }

    async function getAddress(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await response.json();
            return data.display_name.split(',').slice(0, 2).join(',');
        } catch (e) { return `${lat.toFixed(4)}, ${lon.toFixed(4)}`; }
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * R * 1.3);
    }

    function handleSalida() {
        document.getElementById('loading').style.display = 'block';
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const addr = await getAddress(pos.coords.latitude, pos.coords.longitude);
            state.inProgress = {
                id: 'M-' + Math.random().toString(36).substr(2, 4).toUpperCase(),
                start: new Date().getTime(),
                startAddr: addr,
                lat: pos.coords.latitude,
                lon: pos.coords.longitude
            };
            document.getElementById('loading').style.display = 'none';
            document.getElementById('btnSalida').disabled = true;
            document.getElementById('btnLlegada').disabled = false;
            save();
            renderAll();
        });
    }

    function handleLlegada() {
        document.getElementById('loading').style.display = 'block';
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const addr = await getAddress(pos.coords.latitude, pos.coords.longitude);
            const endTime = new Date().getTime();
            const dist = calcularDistancia(state.inProgress.lat, state.inProgress.lon, pos.coords.latitude, pos.coords.longitude);
            const durationMs = endTime - state.inProgress.start;
            
            state.pedidos.unshift({
                ...state.inProgress,
                endAddr: addr,
                distancia: parseFloat(dist.toFixed(2)),
                durationMs: durationMs,
                timeStr: Math.floor(durationMs/60000) + "m " + Math.floor((durationMs%60000)/1000) + "s"
            });
            
            state.inProgress = null;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('btnSalida').disabled = false;
            document.getElementById('btnLlegada').disabled = true;
            save();
            renderAll();
            updateShift();
        });
    }

    function renderAll() {
        // Render Historial
        document.getElementById('historyList').innerHTML = state.pedidos.map((p, i) => `
            <div class="pedido-item">
                <div class="pedido-header" onclick="document.getElementById('c-${i}').classList.toggle('active')">
                    <span>${p.id}</span>
                    <span style="color:var(--neon-blue)">${p.distancia} km ‚ñº</span>
                </div>
                <div id="c-${i}" class="pedido-content">
                    <p>üö© Origen: ${p.startAddr}</p>
                    <p>üèÅ Destino: ${p.endAddr}</p>
                    <p>‚è± Tiempo: ${p.timeStr}</p>
                </div>
            </div>
        `).join('');

        // Calcular Estad√≠sticas Totales
        const totalPedidos = state.pedidos.length;
        const totalKm = state.pedidos.reduce((acc, p) => acc + p.distancia, 0);
        const totalMs = state.pedidos.reduce((acc, p) => acc + p.durationMs, 0);
        
        const totalMin = Math.floor(totalMs / 60000);
        const h = Math.floor(totalMin / 60) ;
        const m = totalMin % 60;

        // Velocidad Media (Distancia total / Tiempo total en horas)
        const avgSpeed = totalMs > 0 ? (totalKm / (totalMs / 3600000)) : 0;

        document.getElementById('totalPedidos').innerText = totalPedidos;
        document.getElementById('totalDist').innerText = totalKm.toFixed(1);
        document.getElementById('totalTime').innerText = `${h}h ${m}m`;
        document.getElementById('avgSpeed').innerText = avgSpeed.toFixed(1);
    }

    function updateShift() {
        state.shiftStart = document.getElementById('shiftStart').value;
        state.shiftEnd = document.getElementById('shiftEnd').value;
        localStorage.setItem('dl_v7_start', state.shiftStart);
        localStorage.setItem('dl_v7_end', state.shiftEnd);
        
        const now = new Date();
        const start = new Date(now.toDateString() + ' ' + state.shiftStart);
        let end = new Date(now.toDateString() + ' ' + state.shiftEnd);
        if (end < start) end.setDate(end.getDate() + 1);
        
        const totalMs = end - start;
        const elapsedMs = now - start;
        let percent = Math.min(100, Math.max(0, (elapsedMs / totalMs) * 100));
        
        document.getElementById('progressBar').style.width = percent + "%";
        document.getElementById('percentText').innerText = percent.toFixed(1) + "% TURNO";
        
        const hours = totalMs / 3600000;
        document.getElementById('tphDisplay').innerText = `TPH: ${(state.pedidos.length / (hours || 1)).toFixed(2)}`;
    }

    function save() {
        localStorage.setItem('dl_v7_pedidos', JSON.stringify(state.pedidos));
        localStorage.setItem('dl_v7_progress', JSON.stringify(state.inProgress));
    }

    function resetApp() {
        if(confirm("¬øRESET TOTAL DE ESTAD√çSTICAS?")) { localStorage.clear(); location.reload(); }
    }

    init();
</script>
</body>
</html>
